# 알람 시스템 설계

## 알람의 종류

- IOS 푸쉬알림: APNS(ApplePushNoficiationService)을 이용한 알림
- 안드로이드 푸쉬 알림: FCM(FirebaseCloudMessaging)을 이용한 알림
- SMS: Twilio같은 메시지 서비스를 이용
- 이메일: 이메일을 전달해주는 서비스

## 알람을 보내기 위한 정보 수집

- 알람을 보내기 위한 필수 정보 수집
- 기기 정보를 수집할 경우
  - 여러개의 기기를 이용할 경우 사용자와 기기의 정보는 1대 n관계로 매핑되어야 함
- 이외에도 이메일, 전화번호등의 정보도 필요에 따라 수집

## 알람을 수신하기 위한 개략적인 설계

### 알람 서비스 단일 서버를 이용한 설계

- 여러 서비스의 알람을 지원할 경우 APNS, SMS등 알림을 보내는 계층이 필요
  - 이를 제어하는 알람 시스템이 필요
- 계층으로 만들시 장점: 알람을 보내는 방식의 확장이 용이함
- 문제점: 서버 1대에 의존함
  - SPOF문제 발생
  - 규모 확장이 어려움

### 메시지 큐를 이용한 설계

- 제공해야하는 알람의 유형별로 큐를 두고 이를 대신 처리하는 작업서버를 통해 알람 처리를 대행하는 방법
  - 작업 서버에서 알람을 보내는 정보의 검증이 가능

## 상세 설계시 고려할 점

### 안정성

- 데이터 손실 방지: 알람 요청이 소실되어서는 안됨
  - 로깅을 하여 백업을 하거나 소실될 시 재전송이 가능한 설계가 필요
- 중복 전송 방지: 같은 알람이 연속으로 가지 않도록 방지

### 알람 템플릿

- 자주 알람을 보내는 서비스는 보내는 알람 양식이 동일함
- 템플릿을 미리 만들어 두고 사용하는 것이 효율적
- 알람의 일관성도 유지시켜줌

### 알람 거부

- 잦은 알람을 받는 사용자는 알람에 대해 피곤함을 느낌
- 알람의 종류, 수신여부를 매칭해 알람을 받을 선택권을 제시해주어야 함

### 전송률 제한

- 알람을 보내는 서비스는 무료가 아님
- 잦은 알람은 사용자가 알람을 끄는 사유가 됨

### 재시도 큐

- 알람 통지가 실패할 경우 재시도를 할 수 있는 재시도 큐에 넣고 재사용이 필요

### 큐 모니터링

- 큐에 쌓인 알람 개수를 보고 작업 서버의 처리량 파악이 가능
  - 알람 개수가 많으면 작업 서버의 개수를 늘려야 함

### 이벤트 추적

- 알람을 보내는 중, 보낸후의 이벤트 추적이 필요
  - 보내기 전: 알람을 보내는 성공 여부
  - 보낸 후: 알람을 수신하고 클릭한 여부
